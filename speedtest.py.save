import os
import re
import subprocess
import time
import json


def getConfig():
    print("getting Config...")

    if (not os.path.isfile('speedtest.cfg')):
        f = open('speedtest.cfg',"w")
        f.write('{"active":true,"path":"test","speedResultFile":"~/speedtest/speedtest.csv","usbFile":"/media/usbstick/speedtest-all.csv"}')

    f = open('speedtest.cfg')
    data = json.load(f)
    return data

data = getConfig()
print("get Config")
if (not data["active"]):
	print("Do nothing")
	exit
print("getting speed data")
response = subprocess.Popen('/usr/bin/speedtest --accept-license --accept-gdpr', shell=True, stdout=subprocess.PIPE).stdout.read().decode('utf-8')

ping = re.search('Latency:\s+(.*?)\s', response, re.MULTILINE)
download = re.search('Download:\s+(.*?)\s', response, re.MULTILINE)
upload = re.search('Upload:\s+(.*?)\s', response, re.MULTILINE)
jitter = re.search('Latency:.*?jitter:\s+(.*?)ms', response, re.MULTILINE)

ping = ping.group(1)
download = download.group(1)
upload = upload.group(1)
jitter = jitter.group(1)

try:
    f1 = open('/home/pi/speedtest/speedtest.csv', 'w+')
    f2 = open('/media/usbstick/speedtest-all.csv',"a+")
except:
    pass

f1.write('{},{},{},{},{},{}\r\n'.format(time.strftime('%d.%m.%y'), time.strftime('%H:%M'), ping, jitter, download, upload))
f2.write('{},{},{},{}\r\n'.format(time.strftime('%d.%m.%y'), time.strftime('%H:%M'), download, upload))
f1.close()
f2.close()
